PALETTE:CP	INK_T
	JR	Z,PAL_I
	CP	PAPER_T
	JR	Z,PAL_P
	CP	TO_T
	JR	Z,PAL_T
	RST	$30
	DEFW	L24FB + 1	; SCANNING + 1
	CALL	SYNTAX_Z
	JR	Z,PAL_SW
	RST	$30
	DEFW	L1E94		; FIND-INT1
	CP	5
ERRBNC:	JP	NC,ERROR_B	; B Integer out of range
	LD	HL,S_MODE
	LD	C,A		; ???
	XOR	(HL)
	AND	$07
	XOR	(HL)
	LD	(HL),A
	LD	B,0
	CALL	STACKSWAP
	LD	HL,PAL_J
	ADD	HL,BC
	LD	C,(HL)
	ADD	HL,BC
	JP	(HL)

PAL_T:	CALL	PAL_S
	JR	C,PAL_SW
	PUSH	AF
	RST	$30
	DEFW	L1E94		; FIND-INT1
	CP	$40
	JR	NC,ERRBNC
	LD	BC,$BF3B
	OUT	(C),A
	LD	B,$FF
	POP	AF
	OUT	(C),A
PAL_SW:	JP	SWAP

PAL_P:	SET	6,(IY+$37)
	JR	PAL_ST
PAL_I:	RES	6,(IY+$37)
PAL_ST:	CALL	PAL_S
	JR	C,PAL_SW
	PUSH	AF
	LD	A,(S_MODE)
	AND	$07
	JR	Z,ERROR_K
	LD	C,A
	LD	B,0
	LD	HL,INKMAX-1
	BIT	6,(IY+$37)
	JR	Z,PAL_NP
	LD	HL,PAPMAX-1
PAL_NP:	ADD	HL,BC
	PUSH	HL
	RST	$30
	DEFW	L1E94		; FIND-INT1
	POP	HL
	CP	(HL)
	JR	NC,ERROR_K
	LD	B,A
	AND	$18
	ADD	A,A
	LD	C,A
	LD	A,B
	AND	$07
	BIT	6,(IY+$37)
	JR	Z,PAL_NN
	OR	$08
PAL_NN:	OR	C
	POP	DE
PAL_SL:	LD	BC,$BF3B
	OUT	(C),A
	LD	B,$FF
	OUT	(C),D
	ADD	A,(HL)
	ADD	A,(HL)
	CP	$40
	JR	C,PAL_SL
	JP	SWAP

ERROR_K:RST	$30
	DEFW	L2244		; K Invalid colour

PAL_S:	CALL	NEXT_1NUM
	CP	";"
PERRCNZ:JP	NZ,ERROR_C
	CALL	NEXT_1NUM
	CP	","
	JR	NZ,PERRCNZ
	CALL	NEXT_2NUM
	CP	":"
	JP	Z,PAL_IC
	CP	$0D
	JR	NZ,PERRCNZ
PAL_IC:	SCF
	CALL	UNSTACK_Z

PAL_RGB:CALL	BYTEFP		; BLUE
	RLCA
	RLCA
	AND	$03
	PUSH	AF
	CALL	BYTEFP		; GREEN
	AND	$E0
	PUSH	AF
	CALL	BYTEFP		; RED
	RRCA
	RRCA
	RRCA
	AND	$1C
	POP	BC
	OR	B
	POP	BC
	OR	B
	RET

BYTEFP:	RST	$28
	DEFB	$3D		; re-stack
	DEFB	$38		; end
	LD	A,(HL)
	ADD	8		; multiply by 256
	CP	$89
	JR	NC,BYTEFF
	LD	(HL),A
	INC	HL
	LD	A,(HL)
	ADD	A,A
	JR	C,BYTE00
	RST	$30
	DEFW	L2DD5		; FP-TO-A
	RET

BYTEFF:	INC	HL
	LD	A,(HL)
	ADD	A,A
BYTE00:	CCF
	SBC	A,A
	DEC	HL
	LD	(STKEND),HL
	RET

INKMAX:	DEFB	8,32,16,8
PAPMAX:	DEFB	32,8,16,8

PAL_J:	DEFB	PAL_0 - $
	DEFB	PAL_1 - $
	DEFB	PAL_2 - $
	DEFB	PAL_3 - $
	DEFB	PAL_4 - $

PAL_0:	XOR	A
	JR	PAL_X		; TODO: better ways of skipping 2 bytes

PAL_1:	CALL	PALSUP
	JR	PALL

PAL_2:	CALL	PALSUP
	EXX
PALL:	LD	BC,$BF3B
	OUT	(C),E
	BIT	3,E
	JR	NZ,PALPS
	LD	A,E
	CALL	PAL_M
	JR	PALS
PALPS:	LD	A,E
	EXX
	CALL	PAL_M
	EXX
PALS:	LD	BC,$FF3B
	OUT	(C),A
	DEC	E
	JR	NZ,PALL
PAL_ON:	LD	A,1
PAL_X:	LD	BC,$BF3B
	LD	D,$40
	OUT	(C),D
	LD	B,$FF
	OUT	(C),A
	RET

PAL_3:	LD	E,$00
	LD	HL,COLTAB
	CALL	PAL_34		; 00 INK
	LD	HL,COLTAB
	CALL	PAL_34		; 00 PAPER
	CALL	PAL_34		; 01 INK
	LD	HL,COLTAB
	CALL	PAL_34		; 01 PAPER
	LD	HL,COLTAB
	CALL	PAL_34		; 10 INK
	CALL	PAL_34		; 10 PAPER
	LD	HL,COLTABB
	CALL	PAL_34		; 11 INK
	LD	HL,COLTABB
	CALL	PAL_34		; 11 PAPER
	JR	PAL_ON

PAL_4:	LD	E,$00
	LD	HL,COLTAB
	CALL	PAL_34		; 00 INK
	LD	HL,COLTAB
	CALL	PAL_34		; 00 PAPER
	CALL	PAL_34		; 01 INK
	LD	HL,COLTABB
	CALL	PAL_34		; 01 PAPER
	LD	HL,COLTAB
	CALL	PAL_34		; 10 INK
	CALL	PAL_34		; 10 PAPER
	LD	HL,COLTABB
	CALL	PAL_34		; 11 INK
	LD	HL,COLTAB
	CALL	PAL_34		; 11 PAPER
	JR	PAL_ON

PAL_34:	LD	D,8
PAL_LL:	LD	BC,$BF3B
	OUT	(C),E
	INC	E
	LD	B,$FF
	LD	A,(HL)
	INC	HL
	OUT	(C),A
	DEC	D
	JR	NZ,PAL_LL
	RET

PALSUP:	LD	HL,COLTAB
	LD	D,$37
	EXX
	LD	HL,COLTABB
	LD	D,$07
	LD	E,$3F
	RET

PAL_M:	AND	D
	LD	C,A
	AND	7
	LD	B,A
	LD	A,C
	RRA
	AND	$18
	OR	B
	LD	C,A
	LD	B,0
	ADD	HL,BC
	LD	A,(HL)
	SBC	HL,BC
	RET

COLTAB:	DEFB	$00		; BLACK
	DEFB	$02		; BLUE
	DEFB	$14		; RED
	DEFB	$16		; MAGENTA
	DEFB	$A0		; GREEN
	DEFB	$A2		; CYAN
	DEFB	$B4		; YELLOW
	DEFB	$B6		; WHITE

COLTABB:DEFB	$00		; BLACK
	DEFB	$03		; BRIGHT BLUE
	DEFB	$1C		; BRIGHT RED
	DEFB	$1F		; BRIGHT MAGENTA
	DEFB	$E0		; BRIGHT GREEN
	DEFB	$E3		; BRIGHT CYAN
	DEFB	$FC		; BRIGHT YELLOW
	DEFB	$FF		; BRIGHT WHITE

	DEFB	$17		; VIOLET
	DEFB	$1E		; PURPLE
	DEFB	$A3		; SKY
	DEFB	$B7		; STEEL
	DEFB	$BC		; ORANGE
	DEFB	$BE		; PEACH
	DEFB	$BF		; PINK
	DEFB	$E2		; TURQUOISE

	DEFB	$F4		; GRASS
	DEFB	$F6		; CRICKET
	DEFB	$F7		; LIGHT BLUE
	DEFB	$FE		; SEPIA
	DEFB	$49		; GRAY
	DEFB	$40		; DARK GREEN
	DEFB	$2c		; BROWN
	DEFB	$28		; DARK BROWN
